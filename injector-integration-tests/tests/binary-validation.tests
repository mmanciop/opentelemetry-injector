# shellcheck shell=sh
# shellcheck disable=SC2059

# Copyright The OpenTelemetry Authors
# SPDX-License-Identifier: Apache-2.0

# Binary validation tests that check the injector binary for correctness.
# These tests validate ELF binary properties rather than runtime behavior.

# Note: These tests use a dedicated binary validation container with binutils for readelf.

# Test: Verify the injector binary has no weak dynamic symbols.
# Weak symbols can cause issues with symbol resolution and should not be present.
# shellcheck disable=SC2034
check_no_weak_dynamic_symbols() {
  echo "checking injector binary for weak dynamic symbols"
  injector_binary=/injector/libotelinject.so

  # Use readelf to get dynamic symbols and check for WEAK binding
  weak_symbols=$(readelf --dyn-syms "$injector_binary" 2>/dev/null | grep -E "WEAK" || true)

  if [ -n "$weak_symbols" ]; then
    printf "${RED}test \"no weak dynamic symbols\" failed:${NC}\n"
    echo "The injector binary contains weak dynamic symbols, which is not allowed."
    echo "Weak symbols found:"
    echo "$weak_symbols"
    echo "--- end of output"
    exit_code=1
  else
    printf "${GREEN}test \"no weak dynamic symbols\" successful${NC}\n"
    if [ "${VERBOSE:-}" = "true" ]; then
      echo "No weak dynamic symbols found in the injector binary."
      echo "--- end of output"
    fi
  fi
}

check_no_weak_dynamic_symbols
